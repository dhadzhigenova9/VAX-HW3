<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="utf-8">
<title>Оглеждане в стая - Корекция</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
body { margin:0; overflow:hidden; background:#000; font-family:sans-serif; }
#btn {
    position:absolute; top:50%; left:50%;
    transform:translate(-50%,-50%);
    padding:20px 30px; font-size:20px;
    z-index:10; cursor:pointer;
}
</style>
</head>
<body>

<button id="btn">Разреши сензори (Landscape Right)</button>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
let scene, camera, cameraParent, renderer;
let targetPitch = 0, targetYaw = 0;
let currentPitch = 0, currentYaw = 0;
let startAlpha = null, startGamma = null;
const LERP = 0.1;

init();
animate();

function init() {
    scene = new THREE.Scene();

    // Камера и parent
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.rotation.order = 'YXZ';
    camera.position.set(0,0,0);

    cameraParent = new THREE.Object3D();
    cameraParent.add(camera);
    scene.add(cameraParent);

    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff,0.4));
    let light = new THREE.DirectionalLight(0xffffff,0.8);
    light.position.set(5,10,7);
    scene.add(light);

    // Стая
    let roomGeo = new THREE.BoxGeometry(30,15,30);
    let room = new THREE.Mesh(roomGeo,new THREE.MeshLambertMaterial({color:0x1faa3a, side:THREE.BackSide}));
    scene.add(room);

    // Конуси
    let coneGeo = new THREE.ConeGeometry(0.35,1.2,24);
    coneGeo.translate(0,0.6,0);
    for(let i=0;i<80;i++){
        let c1 = new THREE.Mesh(coneGeo,new THREE.MeshLambertMaterial({color:Math.random()*0xffffff}));
        c1.position.set(Math.random()*28-14,-7.5,Math.random()*28-14);
        scene.add(c1);
        let c2 = c1.clone();
        c2.position.y = 7.5;
        c2.rotation.x = Math.PI;
        scene.add(c2);
    }

    window.addEventListener("resize",onResize);
    setupOrientation();
}

function setupOrientation() {
    const btn = document.getElementById("btn");
    btn.onclick = ()=>{
        if(typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function"){
            DeviceOrientationEvent.requestPermission().then(p=>{
                if(p==="granted") window.addEventListener("deviceorientation",onOrientation);
                btn.style.display="none";
            });
        } else {
            window.addEventListener("deviceorientation",onOrientation);
            btn.style.display="none";
        }
    };
}

function onOrientation(e){
    if(e.alpha===null) return;

    // Запазваме началната ориентация при първо събитие
    if(startAlpha===null) startAlpha = e.alpha;
    if(startGamma===null) startGamma = e.gamma;

    // Yaw: alpha относително спрямо начална позиция
    let deltaAlpha = e.alpha - startAlpha;
    if(deltaAlpha>180) deltaAlpha-=360;
    if(deltaAlpha<-180) deltaAlpha+=360;
    targetYaw = THREE.MathUtils.degToRad(deltaAlpha);

    // Pitch: gamma относително спрямо начална позиция
    let deltaGamma = e.gamma - startGamma;
    // Ограничаваме между -90° и +90°
    if(deltaGamma>90) deltaGamma=90;
    if(deltaGamma<-90) deltaGamma=-90;
    targetPitch = THREE.MathUtils.degToRad(deltaGamma);
}

function onResize(){
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate(){
    requestAnimationFrame(animate);

    currentPitch += (targetPitch - currentPitch)*LERP;
    currentYaw += (targetYaw - currentYaw)*LERP;

    camera.rotation.x = currentPitch;
    cameraParent.rotation.y = currentYaw;

    renderer.render(scene,camera);
}
</script>
</body>
</html>
