<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="utf-8">
<title>Оглеждане в стая</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<style>
body { margin: 0; overflow: hidden; background: #000; }
#btn {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  padding: 16px 24px;
  font-size: 18px;
  z-index: 10;
}
</style>
</head>
<body>

<button id="btn">Разреши движение</button>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

<script>
let scene, camera, renderer;

const SMOOTH = 0.12;
let targetYaw = 0, targetPitch = 0;
let yaw = 0, pitch = 0;

init();
animate();

function init() {
  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000);
  camera.rotation.order = "YXZ";

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(innerWidth, innerHeight);
  document.body.appendChild(renderer.domElement);

  scene.add(new THREE.AmbientLight(0xffffff, 0.4));
  const light = new THREE.DirectionalLight(0xffffff, 0.8);
  light.position.set(5, 10, 7);
  scene.add(light);

  // ---- room ----
  const roomW = 30, roomH = 15, roomD = 30;
  const roomGeo = new THREE.BoxGeometry(roomW, roomH, roomD);
  const room = new THREE.Mesh(
    roomGeo,
    new THREE.MeshBasicMaterial({ color: 0x1faa3a, side: THREE.BackSide })
  );
  scene.add(room);

  const edges = new THREE.EdgesGeometry(roomGeo);
  const edgeLines = new THREE.LineSegments(
    edges,
    new THREE.LineBasicMaterial({ color: 0xffffff })
  );
  edgeLines.scale.set(0.999, 0.999, 0.999);
  scene.add(edgeLines);

  // ---- cones ----
  const coneH = 1.2;
  const coneGeo = new THREE.ConeGeometry(0.35, coneH, 24);
  coneGeo.translate(0, coneH/2, 0);

  function rand(a,b){return Math.random()*(b-a)+a;}
  function addCone(x,y,z){
    const cone = new THREE.Mesh(
      coneGeo,
      new THREE.MeshLambertMaterial({ color: new THREE.Color(rand(0,1),rand(0,1),rand(0,1)) })
    );
    cone.position.set(x,y,z);
    scene.add(cone);
  }

  const hw = roomW/2, hh = roomH/2, hd = roomD/2;
  for(let i=0;i<60;i++){
    addCone(hw-0.5, rand(-hh,hh), rand(-hd,hd));
    addCone(-hw+0.5, rand(-hh,hh), rand(-hd,hd));
    addCone(rand(-hw,hw), rand(-hh,hh), hd-0.5);
    addCone(rand(-hw,hw), rand(-hh,hh), -hd+0.5);
  }
  for(let i=0;i<80;i++){
    addCone(rand(-hw,hw), -hh+0.01, rand(-hd,hd));
    addCone(rand(-hw,hw), hh-coneH-0.01, rand(-hd,hd));
  }

  window.addEventListener("resize",()=> {
    camera.aspect = innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
  });

  setupOrientation();
}

function setupOrientation() {
  const btn = document.getElementById("btn");
  if(DeviceOrientationEvent?.requestPermission){
    btn.onclick = () => {
      DeviceOrientationEvent.requestPermission().then(p=>{
        if(p==="granted"){
          window.addEventListener("deviceorientation", onOrientation,true);
          btn.remove();
        }
      });
    };
  } else {
    btn.remove();
    window.addEventListener("deviceorientation", onOrientation,true);
  }
}

// ---- device orientation handler ----
function onOrientation(e){
  if(e.beta===null || e.gamma===null) return;

  // ---- FIXED for LANDSCAPE RIGHT ----
  targetYaw = THREE.MathUtils.degToRad(e.gamma); // наляво/надясно
  targetPitch = THREE.MathUtils.degToRad(e.beta) - Math.PI/2; // нагоре/надолу
  targetPitch = THREE.MathUtils.clamp(targetPitch, -Math.PI/2 +0.05, Math.PI/2 -0.05);
}

// ---- animate ----
function animate(){
  requestAnimationFrame(animate);

  yaw += (targetYaw - yaw) * SMOOTH;
  pitch += (targetPitch - pitch) * SMOOTH;

  camera.rotation.y = yaw;
  camera.rotation.x = pitch;

  renderer.render(scene, camera);
}
</script>

</body>
</html>
